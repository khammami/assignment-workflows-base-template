name: Autograding Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
permissions:
  checks: write
  actions: read
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  ANDROID_APP_PATH: "application"
  README_PATH: "."

jobs:
  run-autograding-tests:
    name: Autograding
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >-
      ${{ !github.event.repository.is_template
          && github.actor != 'github-classroom[bot]' }}
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      # Repository checks
      # 1 - Check if the application folder contains an Android project
      - name: Auto-detect Android project
        shell: bash
        run: |
          set -euo pipefail

          # Search for gradlew which indicates the root of an Android project
          GRADLEW_PATH=$(find ${{env.ANDROID_APP_PATH}} -name "gradlew" -type f | head -n 1)

          if [ -z "$GRADLEW_PATH" ]; then
            echo "No Android project (gradlew) found under application/"
            exit 1
          fi

          # Extract the directory containing gradlew
          DETECTED_PATH=$(dirname "$GRADLEW_PATH")
          echo "Android project detected at: $DETECTED_PATH"

          # Override the ANDROID_APP_PATH environment variable
          echo "ANDROID_APP_PATH=$DETECTED_PATH" >> $GITHUB_ENV

      # 2 - Check for README.md
      - name: Check for README.md
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${{env.README_PATH}}/README.md" ]; then
              echo "README.md found"
          else
              echo "No README.md found"
              exit 1
          fi

      # To use with instrumentation tests
      # - name: Delete unnecessary tools ðŸ”§
      #   uses: jlumbroso/free-disk-space@v1.3.1
      #   with:
      #     android: false # Don't remove Android tools
      #     tool-cache: true # Remove image tool cache
      #     dotnet: true
      #     haskell: true
      #     swap-storage: true

      # To use with instrumentation tests
      # Enable KVM for emulator
      - name: Enable KVM
        shell: bash
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Make all scripts executable
        run: |
          find .github/scripts -type f -name "*.sh" -exec chmod +x {} \;
          chmod +x ${{env.ANDROID_APP_PATH}}/gradlew

      - name: Copy CI gradle.properties
        run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

      - name: Extract Java version from Gradle files
        run: |
          set -euo pipefail
          JAVA_VERSION=""

          # Check app module build files first (build.gradle or build.gradle.kts)
          for BUILD_FILE in "${{env.ANDROID_APP_PATH}}/app/build.gradle.kts" "${{env.ANDROID_APP_PATH}}/app/build.gradle" "${{env.ANDROID_APP_PATH}}/build.gradle.kts" "${{env.ANDROID_APP_PATH}}/build.gradle"; do
            if [ -f "$BUILD_FILE" ]; then
              echo "Checking $BUILD_FILE for Java version..."
              
              # Try to extract version number from various formats:
              # JavaVersion.VERSION_1_8 or JavaVersion.VERSION_11 -> 8 or 11
              # sourceCompatibility = "17" -> 17
              # sourceCompatibility = 17 -> 17
              # sourceCompatibility JavaVersion.toVersion("11") -> 11
              JAVA_VERSION=$(grep -E "(sourceCompatibility|targetCompatibility)" "$BUILD_FILE" | head -n1 | \
                sed -E 's/.*VERSION_1_([0-9]+).*/\1/; s/.*VERSION_([0-9]+).*/\1/; s/.*[=:]\s*"?([0-9]+)"?.*/\1/; s/.*toVersion\("([0-9]+)"\).*/\1/' | \
                grep -E '^[0-9]+$' || true)
              
              if [ -n "$JAVA_VERSION" ]; then
                echo "Found Java version from compatibility settings: $JAVA_VERSION"
                break
              fi
            fi
          done

          # Try toolchain configuration if not found
          if [ -z "$JAVA_VERSION" ]; then
            echo "Attempting to extract Java version from toolchain configuration..."
            for BUILD_FILE in "${{env.ANDROID_APP_PATH}}/app/build.gradle.kts" "${{env.ANDROID_APP_PATH}}/app/build.gradle" "${{env.ANDROID_APP_PATH}}/build.gradle.kts" "${{env.ANDROID_APP_PATH}}/build.gradle"; do
              if [ -f "$BUILD_FILE" ]; then
                JAVA_VERSION=$(grep -Pzo '(?s)toolchains.*?languageVersion\s*=\s*JavaVersion\.of\("?\K[0-9]+' "$BUILD_FILE" | tr -d '\0' || true)
                if [ -n "$JAVA_VERSION" ]; then
                  echo "Found Java version from toolchain: $JAVA_VERSION"
                  break
                fi
              fi
            done
          fi

          # Default to 17 if still not found
          if [ -z "$JAVA_VERSION" ]; then
            echo "Could not automatically determine Java version. Defaulting to 17."
            JAVA_VERSION=17 
          fi

          # Enforce minimum Java 11 (required by modern Android Gradle Plugin 7.0+)
          if [ "$JAVA_VERSION" -lt 11 ]; then
            echo "Detected Java $JAVA_VERSION, but Android Gradle Plugin requires minimum Java 11. Upgrading to Java 11."
            JAVA_VERSION=11
          fi

          echo "Detected Java Version: $JAVA_VERSION"
          echo $JAVA_VERSION > ${{env.ANDROID_APP_PATH}}/.java-version
        shell: bash

      # Setup min version of Java required by Gradle
      - name: Set up JDK dynamically
        uses: actions/setup-java@v5
        with:
          java-version-file: ${{env.ANDROID_APP_PATH}}/.java-version
          distribution: "temurin"

      # Let gradle action handle all cache related to gradle operations
      - name: Gradle setup/cache
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false # Allow write to cache beside default branch

      - name: Android summary via Gradle (init script)
        id: android_summary
        shell: bash
        env:
          APP_PATH: ${{ env.ANDROID_APP_PATH }}
        run: |
          set -euo pipefail
          cp .github/android-summary.init.gradle "$APP_PATH/"

          "$APP_PATH/gradlew" -p "$APP_PATH" -q --console=plain \
            -I "android-summary.init.gradle" \
            -Dandroid.summary.out="$PWD/android-summary.json" \
            printAndroidSummary --no-configuration-cache

          # Extract first application module values as individual outputs
          min_sdk=$(jq -r '.modules[] | select(.type=="application") | .min_sdk' android-summary.json | head -n1)
          target_sdk=$(jq -r '.modules[] | select(.type=="application") | .target_sdk' android-summary.json | head -n1)
          compile_sdk=$(jq -r '.modules[] | select(.type=="application") | .compile_sdk' android-summary.json | head -n1)
          package_name=$(jq -r '.modules[] | select(.type=="application") | .package_name' android-summary.json | head -n1)
          version_name=$(jq -r '.modules[] | select(.type=="application") | .version_name' android-summary.json | head -n1)
          version_code=$(jq -r '.modules[] | select(.type=="application") | .version_code' android-summary.json | head -n1)
          language=$(jq -r '.modules[] | select(.type=="application") | .language' android-summary.json | head -n1)

          {
            echo "min_sdk=$min_sdk"
            echo "target_sdk=$target_sdk"
            echo "compile_sdk=$compile_sdk"
            echo "package_name=$package_name"
            echo "version_name=$version_name"
            echo "version_code=$version_code"
            echo "language=$language"
          } >> "$GITHUB_OUTPUT"

      - name: Android project summary
        if: always()
        run: |
          {
            echo "## Android Project Summary"
            echo
            echo "**Package:** ${{ steps.android_summary.outputs.package_name }}"
            echo "- minSdk: ${{ steps.android_summary.outputs.min_sdk }}"
            echo "- targetSdk: ${{ steps.android_summary.outputs.target_sdk }}"
            echo "- compileSdk: ${{ steps.android_summary.outputs.compile_sdk }}"
            echo "- versionName: ${{ steps.android_summary.outputs.version_name }}"
            echo "- versionCode: ${{ steps.android_summary.outputs.version_code }}"
            echo "- language: ${{ steps.android_summary.outputs.language }}"
            echo
          } >> "$GITHUB_STEP_SUMMARY"

      # Create env that need to be injected to child process
      - name: Create file for setting env vars
        # https://github.com/education/autograding/issues/69#issuecomment-1497674655
        # https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#using-secrets-in-a-workflow
        # Define ANSWERS_SECRET_PASSPHRASE under your org secrets
        env:
          ANSWERS_SECRET_PASSPHRASE: ${{ secrets.ANSWERS_SECRET_PASSPHRASE }}
        run: |
          echo "#!/bin/sh" > setenv.sh
          echo "export ANSWERS_SECRET_PASSPHRASE=\"$ANSWERS_SECRET_PASSPHRASE\"" >> setenv.sh
          echo "export README_PATH=\"$README_PATH\"" >> setenv.sh
          echo "export ANDROID_APP_PATH=\"$ANDROID_APP_PATH\"" >> setenv.sh
          echo "export ANDROID_HOME=\"$ANDROID_HOME\"" >> setenv.sh
          echo "export ANDROID_NDK=\"$ANDROID_NDK\"" >> setenv.sh
          echo "export ANDROID_NDK_HOME=\"$ANDROID_NDK_HOME\"" >> setenv.sh
          echo "export ANDROID_NDK_LATEST_HOME=\"$ANDROID_NDK_LATEST_HOME\"" >> setenv.sh
          echo "export ANDROID_NDK_ROOT=\"$ANDROID_NDK_ROOT\"" >> setenv.sh
          echo "export ANDROID_SDK_ROOT=\"$ANDROID_SDK_ROOT\"" >> setenv.sh
          chmod +x setenv.sh

      - name: Build Debug
        id: build-debug
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Build Debug
          setup-command: ""
          command: ". ./setenv.sh && ./$ANDROID_APP_PATH/gradlew assembleDebug --no-configuration-cache --stacktrace -p $ANDROID_APP_PATH"
          timeout: 5
          max-score: 5

      # Spotless check (formatting) via init script, no student changes required
      - name: Spotless
        id: spotless
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Spotless
          setup-command: ". ./setenv.sh && cp .github/spotless.init.gradle $ANDROID_APP_PATH/"
          command: ". ./setenv.sh && ./$ANDROID_APP_PATH/gradlew -p $ANDROID_APP_PATH --no-configuration-cache -I spotless.init.gradle spotlessCheck"
          timeout: 5
          max-score: 2

      - name: Q1
        id: q1
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Q1
          setup-command: ". ./setenv.sh && ./.github/scripts/decrypt_answers.sh"
          command: ". ./setenv.sh && ./.github/scripts/check_questions.sh 1"
          timeout: 1
          max-score: 1

      - name: Q2
        id: q2
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Q2
          setup-command: ". ./setenv.sh && ./.github/scripts/decrypt_answers.sh"
          command: ". ./setenv.sh && ./.github/scripts/check_questions.sh 2"
          timeout: 1
          max-score: 1

      - name: Q3
        id: q3
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Q3
          setup-command: ". ./setenv.sh && ./.github/scripts/decrypt_answers.sh"
          command: ". ./setenv.sh && ./.github/scripts/check_questions.sh 3"
          timeout: 1
          max-score: 1

      - name: Q4
        id: q4
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Q4
          setup-command: ". ./setenv.sh && ./.github/scripts/decrypt_answers.sh"
          command: ". ./setenv.sh && ./.github/scripts/check_questions.sh 4"
          timeout: 1
          max-score: 1

      - name: Autograding Reporter
        uses: classroom-resources/autograding-grading-reporter@v1
        env:
          BUILD-DEBUG_RESULTS: "${{steps.build-debug.outputs.result}}"
          SPOTLESS_RESULTS: "${{steps.spotless.outputs.result}}"
          Q1_RESULTS: "${{steps.q1.outputs.result}}"
          Q2_RESULTS: "${{steps.q2.outputs.result}}"
          Q3_RESULTS: "${{steps.q3.outputs.result}}"
          Q4_RESULTS: "${{steps.q4.outputs.result}}"
        with:
          runners: build-debug,spotless,q1,q2,q3,q4
