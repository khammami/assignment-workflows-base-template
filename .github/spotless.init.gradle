// Make Spotless available to THIS init script
initscript {
    repositories {
        gradlePluginPortal()
        mavenCentral()
    }
    dependencies {
        classpath("com.diffplug.spotless:spotless-plugin-gradle:7.2.1")
    }
}

allprojects { Project p ->
    // Ensure repos for Spotless engines (ktlint, google-java-format)
    p.repositories {
        mavenCentral()
        google()
        maven { url = uri("https://plugins.gradle.org/m2/") }
    }

    // Apply Spotless by CLASS (works with init script classpath)
    apply plugin: com.diffplug.gradle.spotless.SpotlessPlugin

    // Configure the Spotless extension explicitly to avoid missing-method issues
    p.extensions.configure(com.diffplug.gradle.spotless.SpotlessExtension) { ext ->
        // Kotlin source
        kotlin {
            target("**/*.kt")
            targetExclude("**/build/**")
            ktlint("1.3.1")
            trimTrailingWhitespace()
            endWithNewline()
        }

        // Kotlin Gradle scripts
        kotlinGradle {
            target("**/*.gradle.kts")
            ktlint("1.3.1")
            trimTrailingWhitespace()
            endWithNewline()
        }

        // Java (if present)
        java {
            target("**/*.java")
            targetExclude("**/build/**")
            googleJavaFormat("1.17.0")
            trimTrailingWhitespace()
            endWithNewline()
        }

        // Misc text (optional)
        format("misc") {
            target("**/*.md", "**/*.xml", "**/*.yml", "**/*.yaml", "**/.gitignore", "**/.gitattributes")
            targetExclude("**/build/**", ".gradle/**")
            trimTrailingWhitespace()
            endWithNewline()
        }
    }
}